<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Register - Smart Attendance System</title>
    <link rel="stylesheet" href="styles.css">
    <!-- Face-api.js CDN -->
    <script async defer src="https://cdn.jsdelivr.net/npm/@vladmandic/face-api/dist/face-api.min.js"></script>
</head>
<body>
    <div class="container">
        <div class="form-section">
            <h1>Student Registration</h1>
            
            <form id="registrationForm">
                <div class="form-group">
                    <label for="studentName">Student Name:</label>
                    <input 
                        type="text" 
                        id="studentName" 
                        name="studentName" 
                        placeholder="Enter your full name"
                        required
                    >
                </div>

                <div class="form-group">
                    <label for="rollNumber">Roll Number:</label>
                    <input 
                        type="text" 
                        id="rollNumber" 
                        name="rollNumber" 
                        placeholder="Enter your roll number"
                        required
                    >
                </div>

                <div class="form-group">
                    <label for="password">Password:</label>
                    <input 
                        type="password" 
                        id="password" 
                        name="password" 
                        placeholder="Create a password"
                        required
                    >
                </div>

                <div class="form-group">
                    <label for="confirmPassword">Confirm Password:</label>
                    <input 
                        type="password" 
                        id="confirmPassword" 
                        name="confirmPassword" 
                        placeholder="Confirm your password"
                        required
                    >
                </div>

                <div class="camera-section">
                    <h3>Capture Your Photo</h3>
                    <button type="button" id="startCameraButton" class="btn btn-secondary">
                        Start Camera
                    </button>
                    <video id="cameraFeed" autoplay playsinline style="display: none;"></video>
                    <button type="button" id="captureButton" class="btn btn-secondary" style="display: none;">
                        Capture Photo
                    </button>
                    <button type="button" id="stopCameraButton" class="btn btn-secondary" style="display: none;">
                        Stop Camera
                    </button>
                </div>

                <canvas id="photoCanvas" style="display: none;"></canvas>
                
                <div id="photoPreview" class="photo-preview">
                    <img id="capturedImage" src="" alt="Captured Photo" style="display: none;">
                </div>

                <div id="message" class="message"></div>

                <button type="submit" class="btn btn-primary">Register</button>
            </form>

            <div class="auth-link">
                <p>Already a student? <a href="login.html">Login here</a></p>
            </div>

            <div class="back-link">
                <a href="index.html">‚Üê Back to Home</a>
            </div>
        </div>
    </div>

    <script src="app.js"></script>
    <script>
        let capturedImageData = null;
        let stream = null;
        let cameraActive = false;
        let modelsLoaded = false;

        // Load face-api models
        async function loadFaceApiModels() {
            try {
                console.log('Loading face-api models...');
                
                // Check if faceapi is loaded
                if (typeof faceapi === 'undefined') {
                    console.warn('face-api.js not loaded yet, retrying...');
                    setTimeout(loadFaceApiModels, 500);
                    return;
                }

                // Load models from CDN
                const MODEL_URL = 'https://cdn.jsdelivr.net/npm/@vladmandic/face-api/model/';
                
                await Promise.all([
                    faceapi.nets.ssdMobilenetv1.loadFromUri(MODEL_URL),
                    faceapi.nets.faceLandmark68Net.loadFromUri(MODEL_URL),
                    faceapi.nets.faceRecognitionNet.loadFromUri(MODEL_URL)
                ]);

                modelsLoaded = true;
                console.log('‚úì Face-api models loaded successfully');
                
                const messageDiv = document.getElementById('message');
                messageDiv.className = 'message success';
                messageDiv.textContent = 'Face recognition ready! Click "Start Camera" to capture your photo.';
                
            } catch (error) {
                console.error('Error loading face-api models:', error);
                const messageDiv = document.getElementById('message');
                messageDiv.className = 'message warning';
                messageDiv.textContent = 'Face recognition models loading... This may take a moment.';
                
                // Retry loading
                setTimeout(loadFaceApiModels, 2000);
            }
        }

        // Initialize camera only when user clicks "Start Camera" button
        document.getElementById('startCameraButton').addEventListener('click', async function(e) {
            e.preventDefault();
            
            try {
                const video = document.getElementById('cameraFeed');
                stream = await navigator.mediaDevices.getUserMedia({ 
                    video: { 
                        facingMode: 'user',
                        width: { ideal: 640 },
                        height: { ideal: 480 }
                    } 
                });
                
                video.srcObject = stream;
                cameraActive = true;
                
                // Hide start button, show capture and stop buttons
                document.getElementById('startCameraButton').style.display = 'none';
                document.getElementById('captureButton').style.display = 'block';
                document.getElementById('stopCameraButton').style.display = 'block';
                video.style.display = 'block';
                
                const messageDiv = document.getElementById('message');
                messageDiv.className = 'message success';
                messageDiv.textContent = 'Camera started! Click "Capture Photo" to take a picture.';
                
            } catch (error) {
                const messageDiv = document.getElementById('message');
                messageDiv.className = 'message error';
                messageDiv.textContent = 'Camera access denied. Please allow camera access to register.';
                console.error('Camera error:', error);
            }
        });

        // Capture photo
        document.getElementById('captureButton').addEventListener('click', async function(e) {
            e.preventDefault();
            
            const video = document.getElementById('cameraFeed');
            const canvas = document.getElementById('photoCanvas');
            const ctx = canvas.getContext('2d');
            
            canvas.width = video.videoWidth;
            canvas.height = video.videoHeight;
            
            ctx.drawImage(video, 0, 0, canvas.width, canvas.height);
            
            capturedImageData = canvas.toDataURL('image/jpeg');
            
            // IMPORTANT: Store the canvas for face detection later
            // This ensures we use the exact same image for detection
            window.capturedCanvas = canvas.cloneNode(true);
            window.capturedCanvasCtx = window.capturedCanvas.getContext('2d');
            window.capturedCanvasCtx.drawImage(canvas, 0, 0);
            
            const capturedImage = document.getElementById('capturedImage');
            capturedImage.src = capturedImageData;
            capturedImage.style.display = 'block';
            
            const messageDiv = document.getElementById('message');
            messageDiv.className = 'message success';
            messageDiv.textContent = 'Photo captured successfully!';
        });

        // Stop camera
        document.getElementById('stopCameraButton').addEventListener('click', function(e) {
            e.preventDefault();
            
            if (stream) {
                stream.getTracks().forEach(track => track.stop());
            }
            
            cameraActive = false;
            
            const video = document.getElementById('cameraFeed');
            video.style.display = 'none';
            
            document.getElementById('startCameraButton').style.display = 'block';
            document.getElementById('captureButton').style.display = 'none';
            document.getElementById('stopCameraButton').style.display = 'none';
            
            const messageDiv = document.getElementById('message');
            messageDiv.className = 'message';
            messageDiv.textContent = '';
        });

        // Extract face descriptor from canvas image
        async function extractFaceDescriptor(imageData) {
            try {
                console.log('===== EXTRACTING FACE DESCRIPTOR =====');
                
                // Check if face-api is loaded
                if (typeof faceapi === 'undefined') {
                    console.error('‚ùå Face-api not loaded yet');
                    return null;
                }

                // Check if models are loaded
                if (!modelsLoaded) {
                    console.error('‚ùå Face-api models not loaded yet');
                    return null;
                }

                console.log('‚úì Face-api and models are ready');

                // Use the canvas directly if available (more reliable than Image element)
                let detectionSource;
                if (window.capturedCanvas) {
                    console.log('Using captured canvas for detection');
                    detectionSource = window.capturedCanvas;
                } else {
                    console.log('Using Image element for detection (canvas not available)');
                    // Fallback: Create image element
                    const img = new Image();
                    img.src = imageData;
                    
                    // Wait for image to load with timeout
                    await new Promise((resolve, reject) => {
                        img.onload = resolve;
                        img.onerror = reject;
                        setTimeout(() => reject(new Error('Image load timeout')), 5000);
                    });
                    
                    detectionSource = img;
                }

                console.log('Detection source ready:', detectionSource.tagName || detectionSource.constructor.name);
                console.log('Canvas/Image dimensions:', detectionSource.width, 'x', detectionSource.height);

                // Detect face and extract descriptor with timeout
                console.log('Starting face detection...');
                
                const detectionPromise = faceapi
                    .detectSingleFace(detectionSource)
                    .withFaceLandmarks()
                    .withFaceDescriptor();

                // Add timeout to detection
                const timeoutPromise = new Promise((resolve) => {
                    setTimeout(() => {
                        console.warn('‚ö†Ô∏è Detection timeout - face-api taking too long');
                        resolve(null);
                    }, 10000); // 10 second timeout
                });

                const detection = await Promise.race([detectionPromise, timeoutPromise]);
                
                console.log('Detection result:', detection);

                if (detection) {
                    console.log('‚úì Face detected and descriptor extracted');
                    console.log('Descriptor length:', detection.descriptor.length);
                    console.log('Descriptor values (first 5):', Array.from(detection.descriptor).slice(0, 5));
                    console.log('Detection confidence - score:', detection.detection.score);
                    
                    // Convert Float32Array to regular array for JSON storage
                    const descriptorArray = Array.from(detection.descriptor);
                    console.log('‚úì Converted to array, final length:', descriptorArray.length);
                    return descriptorArray;
                } else {
                    console.warn('‚ùå No face detected in image');
                    return null;
                }
            } catch (error) {
                console.error('‚ùå Error extracting face descriptor:', error);
                console.error('Error message:', error.message);
                console.error('Stack:', error.stack);
                return null;
            }
        }

        // Handle registration form submission
        document.getElementById('registrationForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const studentName = document.getElementById('studentName').value.trim();
            const rollNumber = document.getElementById('rollNumber').value.trim();
            const password = document.getElementById('password').value;
            const confirmPassword = document.getElementById('confirmPassword').value;
            const messageDiv = document.getElementById('message');

            console.log('===== REGISTRATION FORM SUBMITTED =====');
            console.log('Name:', studentName);
            console.log('Roll:', rollNumber);
            console.log('Photo captured:', !!capturedImageData);

            // Validate passwords match
            if (password !== confirmPassword) {
                messageDiv.className = 'message error';
                messageDiv.textContent = 'Passwords do not match!';
                return;
            }

            // Check if photo was captured
            if (!capturedImageData) {
                messageDiv.className = 'message error';
                messageDiv.textContent = 'Please capture a photo before registering!';
                return;
            }

            // Show loading state
            messageDiv.className = 'message';
            messageDiv.textContent = 'Processing face... Please wait.';

            // Extract face descriptor
            console.log('Extracting face descriptor...');
            const faceDescriptor = await extractFaceDescriptor(capturedImageData);
            
            console.log('Face descriptor extraction result:', faceDescriptor);
            
            if (!faceDescriptor) {
                messageDiv.className = 'message warning';
                messageDiv.innerHTML = `
                    <div style="margin-bottom: 15px;">
                        ‚ö†Ô∏è <strong>Face not detected clearly.</strong>
                    </div>
                    <p style="margin: 10px 0; font-size: 0.9rem;">
                        The system couldn't detect your face. This could be due to:
                    </p>
                    <ul style="margin: 10px 0; font-size: 0.9rem; text-align: left;">
                        <li>Poor lighting conditions</li>
                        <li>Face not clearly visible in the photo</li>
                        <li>Face too small or at an angle</li>
                    </ul>
                    <p style="margin-top: 15px; font-size: 0.9rem;">
                        You can:
                    </p>
                    <div style="margin-top: 10px;">
                        <button id="retryPhotoBtn" class="btn btn-secondary" style="margin-right: 10px;">
                            üì∑ Retake Photo
                        </button>
                        <button id="continueWithoutFaceBtn" class="btn btn-secondary">
                            ‚úì Continue Registration
                        </button>
                    </div>
                `;
                
                console.warn('‚ö†Ô∏è Face descriptor is NULL - showing retry options');
                
                // Retry photo button
                document.getElementById('retryPhotoBtn').addEventListener('click', function() {
                    console.log('User chose to retake photo');
                    
                    // Reset UI to capture photo again
                    document.getElementById('startCameraButton').style.display = 'block';
                    document.getElementById('captureButton').style.display = 'none';
                    document.getElementById('stopCameraButton').style.display = 'none';
                    
                    const video = document.getElementById('cameraFeed');
                    video.style.display = 'none';
                    
                    capturedImageData = null;
                    window.capturedCanvas = null;
                    
                    const capturedImage = document.getElementById('capturedImage');
                    capturedImage.style.display = 'none';
                    
                    messageDiv.className = '';
                    messageDiv.innerHTML = '';
                    
                    // Restart camera
                    document.getElementById('startCameraButton').click();
                });
                
                // Continue without face button
                document.getElementById('continueWithoutFaceBtn').addEventListener('click', function() {
                    console.log('User chose to continue without face verification');
                    proceedWithRegistration(studentName, rollNumber, password, null, messageDiv);
                });
                
                return;
            } else {
                messageDiv.textContent = 'Registering student... Please wait.';
                console.log('‚úì Face descriptor obtained, length:', faceDescriptor.length);
            }

            // Register student with face descriptor
            proceedWithRegistration(studentName, rollNumber, password, faceDescriptor, messageDiv);
        });

        // Helper function to proceed with registration
        async function proceedWithRegistration(name, roll, password, faceDescriptor, messageDiv) {
            console.log('Sending registration request...');
            console.log('Face descriptor to send:', faceDescriptor ? `[array of ${faceDescriptor.length}]` : 'null');
            
            const result = await AuthManager.register({
                name: name,
                roll: roll,
                password: password,
                image: capturedImageData,
                faceDescriptor: faceDescriptor ? JSON.stringify(faceDescriptor) : null
            });

            console.log('Registration result:', result);

            if (result.success) {
                messageDiv.className = 'message success';
                messageDiv.innerHTML = result.message;
                
                // Stop camera stream
                if (stream) {
                    stream.getTracks().forEach(track => track.stop());
                }
                
                setTimeout(() => {
                    window.location.href = 'login.html';
                }, 1500);
            } else {
                messageDiv.className = 'message error';
                messageDiv.textContent = result.message;
            }
        }

        // Clean up camera stream on page unload
        window.addEventListener('beforeunload', function() {
            if (stream) {
                stream.getTracks().forEach(track => track.stop());
            }
        });

        // Initialize face-api models on page load
        document.addEventListener('DOMContentLoaded', function() {
            console.log('Registration page loaded, initializing face-api...');
            loadFaceApiModels();
        });

        // In case DOMContentLoaded already fired
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', function() {
                loadFaceApiModels();
            });
        } else {
            loadFaceApiModels();
        }
    </script>
</body>
</html>
